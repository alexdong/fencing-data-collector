{% extends "base.html" %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <h1 class="text-2xl font-bold mb-6">New Bout</h1>
    
    <!-- Context Section -->
    <div class="bg-white p-6 rounded-lg shadow mb-6">
        <h2 class="text-xl font-semibold mb-4">Bout Details</h2>
        <form id="boutForm" class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Fencer A</label>
                    <input type="text" name="fencer_a" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Fencer B</label>
                    <input type="text" name="fencer_b" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Bout Type</label>
                    <select name="bout_type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        <option value="pool">Pool</option>
                        <option value="de">DE</option>
                        <option value="practice">Practice</option>
                        <option value="lesson">Lesson</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Round</label>
                    <select name="bout_round" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                    </select>
                </div>
            </div>
        </form>
    </div>

    <!-- Timer Section -->
    <div class="bg-white p-6 rounded-lg shadow mb-6">
        <div class="flex justify-between items-center">
            <div id="timer" class="text-4xl font-mono">00:00</div>
            <div class="space-x-4">
                <button id="startBtn" 
                        class="px-6 py-2 bg-green-500 text-white rounded hover:bg-green-600"
                        hx-post="/api/bout/1/timer/start"
                        hx-swap="none">
                    Start
                </button>
                <button id="stopBtn" 
                        class="px-6 py-2 bg-red-500 text-white rounded hover:bg-red-600"
                        hx-post="/api/bout/1/timer/stop"
                        hx-swap="none">
                    Stop
                </button>
            </div>
        </div>
    </div>

    <!-- Touch Recording Section -->
    <div id="touchForm" class="bg-white p-6 rounded-lg shadow" style="display: none;">
        <h2 class="text-xl font-semibold mb-4">Record Touch</h2>
        <form id="touchRecordForm" class="space-y-4" hx-post="/api/bout/1/touch" hx-swap="none">
            <input type="hidden" name="seconds_from_start" id="secondsFromStart">
            
            <!-- Basic Action Info -->
            <div class="mb-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Basic Action Info</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Scorer</label>
                        <select name="scorer" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                            <option value="fencer_a">Fencer A</option>
                            <option value="fencer_b">Fencer B</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Primary Action</label>
                        <select name="primary_action" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                            <option value="attack">Attack</option>
                            <option value="riposte">Riposte</option>
                            <option value="counter_attack">Counter Attack</option>
                            <option value="remise">Remise</option>
                            <option value="counter_riposte">Counter Riposte</option>
                            <option value="renewal">Renewal</option>
                            <option value="point_in_line">Point in Line</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Preparation -->
            <div class="mb-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Preparation</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Footwork</label>
                        <select name="footwork" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                            <option value="advance">Advance</option>
                            <option value="retreat">Retreat</option>
                            <option value="double_advance">Double Advance</option>
                            <option value="double_retreat">Double Retreat</option>
                            <option value="jump_forward">Jump Forward</option>
                            <option value="jump_backward">Jump Backward</option>
                            <option value="fleche">Fleche</option>
                            <option value="none">None</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Blade Preparation</label>
                        <select name="blade_preparation" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                            <option value="engagement">Engagement</option>
                            <option value="beat">Beat</option>
                            <option value="press">Press</option>
                            <option value="absence_of_blade">Absence of Blade</option>
                            <option value="coupe">Coupe</option>
                            <option value="none">None</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Distance -->
            <div class="mb-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Distance</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Distance When Action Started</label>
                        <select name="distance" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                            <option value="close">Close</option>
                            <option value="medium">Medium</option>
                            <option value="long">Long</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Hit Details -->
            <div class="mb-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Hit Details</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Hit Quality</label>
                        <select name="hit_quality" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                            <option value="clear">Clear</option>
                            <option value="flat">Flat</option>
                            <option value="grazing">Grazing</option>
                            <option value="missed">Missed</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Hit Timing</label>
                        <select name="hit_timing" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                            <option value="immediate">Immediate</option>
                            <option value="delayed">Delayed</option>
                            <option value="stop_hit">Stop Hit</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Line</label>
                        <select name="line" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                            <option value="high_outside">High Outside</option>
                            <option value="high_inside">High Inside</option>
                            <option value="low_outside">Low Outside</option>
                            <option value="low_inside">Low Inside</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Specific Target</label>
                        <select name="specific_target" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                            <option value="toe">Toe</option>
                            <option value="leg">Leg</option>
                            <option value="hand">Hand</option>
                            <option value="shoulder">Shoulder</option>
                            <option value="chest">Chest</option>
                            <option value="flank">Flank</option>
                            <option value="arm">Arm</option>
                            <option value="back">Back</option>
                            <option value="head">Head</option>
                            <option value="thigh">Thigh</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Piste Position</label>
                        <select name="piste_position" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                            <option value="far_left">Far Left</option>
                            <option value="left">Left</option>
                            <option value="center">Center</option>
                            <option value="right">Right</option>
                            <option value="far_right">Far Right</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Defense -->
            <div class="mb-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Defense</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Parry Type</label>
                        <select name="parry_type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                            <option value="simple">Simple</option>
                            <option value="circular">Circular</option>
                            <option value="counter">Counter</option>
                            <option value="semi_circular">Semi-Circular</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Parry Number</label>
                        <select name="parry_number" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                            <option value="4">4</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="prime">Prime</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Parry Quality</label>
                        <select name="parry_quality" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                            <option value="clean">Clean</option>
                            <option value="beat_parry">Beat Parry</option>
                            <option value="yielding">Yielding</option>
                            <option value="failed">Failed</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Body Evasion -->
            <div class="mb-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Body Evasion</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Evasion Type</label>
                        <select name="evasion_type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                            <option value="distance">Distance</option>
                            <option value="lateral">Lateral</option>
                            <option value="rotational">Rotational</option>
                            <option value="combined">Combined</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Evasion Timing</label>
                        <select name="evasion_timing" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                            <option value="before_attack">Before Attack</option>
                            <option value="during_attack">During Attack</option>
                            <option value="after_attack">After Attack</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Evasion Success</label>
                        <select name="evasion_success" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                            <option value="avoided_hit">Avoided Hit</option>
                            <option value="partial_avoid">Partial Avoid</option>
                            <option value="failed">Failed</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Evasion Follow-up</label>
                        <select name="evasion_follow_up" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                            <option value="return_guard">Return to Guard</option>
                            <option value="change_distance">Change Distance</option>
                            <option value="change_line">Change Line</option>
                            <option value="disengage">Disengage</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="flex justify-end">
                <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                    Record Touch
                </button>
            </div>
        </form>
    </div>

    <!-- Touches Table -->
    <div id="touchesTable" class="bg-white p-6 rounded-lg shadow mt-6">
        <h2 class="text-xl font-semibold mb-4">Recorded Touches</h2>
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Scorer</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Target</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quality</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Defense</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Evasion</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200" id="touchesTableBody">
            </tbody>
        </table>
    </div>
</div>

<script>
let startTime;
let timerInterval;

document.getElementById('startBtn').addEventListener('click', function() {
    startTime = Date.now();
    timerInterval = setInterval(updateTimer, 1000);
    document.getElementById('touchForm').style.display = 'none';
});

document.getElementById('stopBtn').addEventListener('click', function() {
    clearInterval(timerInterval);
    document.getElementById('touchForm').style.display = 'block';
    document.getElementById('secondsFromStart').value = Math.floor((Date.now() - startTime) / 1000);
});

function updateTimer() {
    const seconds = Math.floor((Date.now() - startTime) / 1000);
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    document.getElementById('timer').textContent = 
        `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
}

document.getElementById('touchRecordForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    
    // Add to table
    const tbody = document.getElementById('touchesTableBody');
    const tr = document.createElement('tr');
    
    const timeCell = document.createElement('td');
    timeCell.className = 'px-6 py-4 whitespace-nowrap';
    timeCell.textContent = document.getElementById('timer').textContent;
    
    const scorerCell = document.createElement('td');
    scorerCell.className = 'px-6 py-4 whitespace-nowrap';
    scorerCell.textContent = formData.get('scorer');
    
    const actionCell = document.createElement('td');
    actionCell.className = 'px-6 py-4 whitespace-nowrap';
    actionCell.textContent = formData.get('primary_action');
    
    const targetCell = document.createElement('td');
    targetCell.className = 'px-6 py-4 whitespace-nowrap';
    targetCell.textContent = `${formData.get('line')} - ${formData.get('specific_target')}`;
    
    const qualityCell = document.createElement('td');
    qualityCell.className = 'px-6 py-4 whitespace-nowrap';
    qualityCell.textContent = formData.get('hit_quality');
    
    const defenseCell = document.createElement('td');
    defenseCell.className = 'px-6 py-4 whitespace-nowrap';
    defenseCell.textContent = formData.get('parry_type') ? 
        `${formData.get('parry_type')} ${formData.get('parry_number')} (${formData.get('parry_quality')})` : 
        'None';
    
    const evasionCell = document.createElement('td');
    evasionCell.className = 'px-6 py-4 whitespace-nowrap';
    evasionCell.textContent = formData.get('evasion_type') ? 
        `${formData.get('evasion_type')} (${formData.get('evasion_success')})` : 
        'None';
    
    tr.appendChild(timeCell);
    tr.appendChild(scorerCell);
    tr.appendChild(actionCell);
    tr.appendChild(targetCell);
    tr.appendChild(qualityCell);
    tr.appendChild(defenseCell);
    tr.appendChild(evasionCell);
    
    tbody.appendChild(tr);
    
    // Reset form
    this.reset();
    document.getElementById('touchForm').style.display = 'none';
});
</script>
{% endblock %}
